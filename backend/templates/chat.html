<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Chat</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <h1>Secure Chat</h1>
    <div id="messages"></div>
    <input type="text" id="message" placeholder="Type your message" />
    <button onclick="sendMessage()">Send</button>

    <script>
      const socket = io();
      let sessionKey;

      // Fetch the server's public key
      fetch('/get-public-key')
        .then((response) => response.json())
        .then((data) => {
          const publicKeyPem = data.public_key;
          const publicKey = forge.pki.publicKeyFromPem(publicKeyPem);

          // Generate a random session key
          sessionKey = forge.random.getBytesSync(16);

          // Encrypt the session key with the server's public key
          const encryptedSessionKey = publicKey.encrypt(sessionKey, 'RSA-OAEP');
          socket.emit('exchange_key', {
            encrypted_session_key: forge.util.encode64(encryptedSessionKey),
          });
        });

      // Send an encrypted message
      function sendMessage() {
        const message = document.getElementById('message').value;
        const iv = forge.random.getBytesSync(16);
        const cipher = forge.cipher.createCipher('AES-CFB', sessionKey);
        cipher.start({ iv: iv });
        cipher.update(forge.util.createBuffer(message));
        cipher.finish();

        const encryptedMessage = iv + cipher.output.getBytes();
        socket.emit('send_message', {
          message: forge.util.encode64(encryptedMessage),
        });
      }

      // Receive an encrypted message
      socket.on('receive_message', (data) => {
        const encryptedMessage = forge.util.decode64(data.message);
        const iv = encryptedMessage.slice(0, 16);
        const ciphertext = encryptedMessage.slice(16);

        const decipher = forge.cipher.createDecipher('AES-CFB', sessionKey);
        decipher.start({ iv: iv });
        decipher.update(forge.util.createBuffer(ciphertext));
        decipher.finish();

        const decryptedMessage = decipher.output.toString();
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML += `<p>${decryptedMessage}</p>`;
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/forge/0.10.0/forge.min.js"></script>
  </body>
</html>
